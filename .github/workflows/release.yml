# Builds the presto plugin and releases it to pypi
name: Build and Release

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
  
# release version number that must be updated for each release
env:
  version_number: '0.20.1RC1'

jobs:
  Bump_Version:
    name: 'Bump Version'
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2.2.2
        with: 
          python-version: '3.8'
          
      - uses: actions/checkout@v2

      - name: Bumping version
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install -r dev_requirements.txt
          bumpversion --config-file .bumpversion-dbt.cfg patch --new-version ${{env.version_number}}
          bumpversion --config-file .bumpversion.cfg patch --new-version ${{env.version_number}} --allow-dirty
          git status

      - name: Commit version bump
        uses: EndBug/add-and-commit@v7
        with:
          author_name: 'Leah Antkiewicz'
          author_email: 'leah.antkiewicz@fishtownanalytics.com'
          message: 'Bumping version to ${{env.version_number}}'
          
  Build:
    runs-on: ubuntu-latest
    needs: Bump_Version
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2.2.2
        with: 
          python-version: '3.8'
          
      - uses: actions/checkout@v2

      - name: Test release
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install -r dev_requirements.txt
          pip install twine
          pip install wheel setuptools
          python setup.py sdist bdist_wheel
          ls dist
          pip install dist/dbt_presto-${{env.version_number}}-py3-none-any.whl
          pip install dist/dbt-presto-${{env.version_number}}.tar.gz
          twine check dist/dbt_presto-${{env.version_number}}-py3-none-any.whl dist/dbt-presto-${{env.version_number}}.tar.gz

  Release:
    runs-on: ubuntu-latest
    environment: Prod
    needs: Build
    steps:
      - name: Setup Python
        uses: actions/setup-python@v2.2.2
        with: 
          python-version: '3.8'
          
      - uses: actions/checkout@v2

      - name: Release to pypi
        run: |
          python3 -m venv env
          source env/bin/activate
          pip install -r dev_requirements.txt
          pip install twine
          pip install wheel setuptools
          python setup.py sdist bdist_wheel
          twine check dist/dbt_presto-${{env.version_number}}-py3-none-any.whl dist/dbt-presto-${{env.version_number}}.tar.gz
  
  Tag:
    runs-on: ubuntu-latest
    needs: Release
    steps:
      - uses: actions/checkout@v2

      - name: Tag release
        uses: EndBug/add-and-commit@v7
        with:
          author_name: 'Leah Antkiewicz'
          author_email: 'leah.antkiewicz@fishtownanalytics.com'
          tag: 'v${{env.version_number}}'
